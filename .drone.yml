# This file creates our 2 docker containers
kind: pipeline
name: Dockers_Builder


# Creation of the DB docker
steps:  
  - name: deploy-mysql-container
    image: hub.codefirst.iut.uca.fr/thomas.bellembois/codefirst-dockerproxy-clientdrone:latest
    environment:
      IMAGENAME: mysql:8.0
      CONTAINERNAME: mysql
      COMMAND: create
      # OVERWRITE: false
      PRIVATE: false
      CODEFIRST_CLIENTDRONE_ENV_MYSQL_ROOT_PASSWORD:          
        from_secret: MYSQL_ROOT_PASSWORD        
      CODEFIRST_CLIENTDRONE_ENV_MYSQL_DATABASE:          
        from_secret: MYSQL_DATABASE       
      CODEFIRST_CLIENTDRONE_ENV_MYSQL_USER:          
        from_secret: MYSQL_USER       
      CODEFIRST_CLIENTDRONE_ENV_MYSQL_PASSWORD:          
        from_secret: MYSQL_PASSWORD


# Creation of a hosting docker for our application
  - name: deploy-container
    image: hub.codefirst.iut.uca.fr/thomas.bellembois/codefirst-dockerproxy-clientdrone:latest
    environment:
      IMAGENAME: reactnativecommunity/react-native-android:2.1
      CONTAINERNAME: container_react
      COMMAND: create
      PRIVATE: false
      OVERWRITE: true



# docker image build (at least I'm trying)
  - name: docker-build-and-push
    image: plugins/docker
    settings:
       dockerfile: Dockerfile
       context: .
       registry: hub.codefirst.iut.uca.fr
       repo: hub.codefirst.iut.uca.fr/lilian.breton/bobparty
       username:
         from_secret: SECRET_REGISTRY_USERNAME
       password:
         from_secret: SECRET_REGISTRY_PASSWORD

# container deployment
  - name: deploy-bob_party-container
    image: hub.codefirst.iut.uca.fr/thomas.bellembois/codefirst-dockerproxy-clientdrone:latest
    environment:
        IMAGENAME: hub.codefirst.iut.uca.fr/lilian.breton/bobparty:latest
        CONTAINERNAME: bob_party_container
        COMMAND: create
        OVERWRITE: true


# sonar setup
  - name: sonar
    CODEFIRST_CLIENTDRONE_ENV_SONAR_TOKEN: sqp_8276da170682406ce11243607e0c60bf17391b11
    commands: 
      - sonar-scanner \
        -Dsonar.projectKey=BOB-PARTY \
        -Dsonar.sources=. \
        -Dsonar.host.url=https://codefirst.iut.uca.fr/sonar